<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪器设备管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --light-bg: #f8f9fa;
            --dark-bg: #1e293b;
            --card-shadow: 0 8px 20px rgba(0,0,0,0.08);
            --card-hover-shadow: 0 12px 30px rgba(0,0,0,0.15);
            --transition-speed: 0.3s;
            --border-color: rgba(0,0,0,0.05);
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: #f0f4f8;
            color: #343a40;
            padding-bottom: 60px;
            transition: background-color 0.3s;
        }
        
        .dark-mode {
            background-color: var(--dark-bg);
            color: #e2e8f0;
        }
        
        .container {
            max-width: 1400px;
        }
        
        .header-container {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .dark-mode .header-container {
            background: linear-gradient(135deg, #2c3e50, #1a2530);
        }
        
        .filter-card {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed) ease;
        }
        
        .dark-mode .filter-card {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .dark-mode .table-container {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-normal { background-color: #28a745; color: white; }
        .status-pending { background-color: #ffc107; color: black; }
        .status-repairing { background-color: #dc3545; color: white; }
        .status-repaired { background-color: #0d6efd; color: white; }
        .status-disabled { background-color: #6c757d; color: white; }
        .status-scrapping { background-color: #6f42c1; color: white; }
        .status-scrapped { background-color: #495057; color: white; }
        
        .card-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .equipment-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all var(--transition-speed) ease;
            border: none;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .dark-mode .equipment-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
        }
        
        .equipment-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
            z-index: 10;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            border-bottom: none;
            position: relative;
            z-index: 2;
        }
        
        .dark-mode .card-header {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }
        
        .card-body {
            padding: 20px;
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }
        
        .card-property {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .dark-mode .card-property {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .card-label {
            font-weight: 500;
            color: #6c757d;
            flex: 0 0 40%;
        }
        
        .dark-mode .card-label {
            color: #a0aec0;
        }
        
        .card-value {
            font-weight: 500;
            color: #343a40;
            text-align: right;
            flex: 0 0 60%;
        }
        
        .dark-mode .card-value {
            color: #e2e8f0;
        }
        
        .barcode-section {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            text-align: center;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .dark-mode .barcode-section {
            background-color: rgba(45, 55, 72, 0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .floating-action-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 50px;
            padding: 10px 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 1000;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all var(--transition-speed) ease;
        }
        
        .dark-mode .floating-action-bar {
            background: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        
        .action-btn {
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .table-hover tbody tr {
            transition: background-color 0.2s;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .dark-mode .table-hover tbody tr:hover {
            background-color: rgba(74, 85, 104, 0.3);
        }
        
        .status-light {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            z-index: 2;
            box-shadow: 0 0 8px currentColor;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .equipment-card {
            animation: fadeIn 0.5s ease-out;
        }
        
        .fault-history {
            max-height: 100px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        
        .dark-mode .fault-history {
            background-color: #1a202c;
        }
        
        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .dark-mode .theme-switch .btn {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        
        .search-highlight {
            background-color: #ffeb3b;
            color: #000;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        .attachment-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .attachment-thumbnail:hover {
            transform: scale(1.05);
        }
        
        .attachment-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .attachment-name {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .attachment-grid {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .preview-attachment-img {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 0 auto;
        }
        
        .print-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            break-inside: avoid;
        }
        
        .print-header {
            border-bottom: 2px solid #4361ee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .print-title {
            font-weight: 600;
            color: #4361ee;
            font-size: 1.2rem;
        }
        
        .print-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .print-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #ddd;
            padding: 5px 0;
        }
        
        .print-label {
            font-weight: 500;
            color: #666;
        }
        
        .print-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .print-barcode {
            margin: 10px auto;
            display: block;
            max-width: 100%;
        }
        
        .print-date {
            text-align: right;
            font-size: 0.85rem;
            color: #666;
        }
        
        .print-container {
            padding: 20px;
            background: white;
            display: none;
            column-count: 2;
            column-gap: 20px;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container, .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                column-count: 2;
                column-gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="theme-switch">
        <button id="themeToggle" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-moon-stars"></i> 暗黑模式
        </button>
    </div>

    <div class="container">
        <!-- 页面标题区 -->
        <div class="header-container">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0"><i class="bi bi-cpu me-2"></i>仪器设备管理系统</h2>
                <div>
                    <a href="{{ url_for('index') }}" class="btn btn-light">
                        <i class="bi bi-house-door me-1"></i> 返回首页
                    </a>
                </div>
            </div>
            <div class="mt-2 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-calendar-check me-2"></i>
                    <span id="currentDate"></span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2">数据更新时间:</span>
                    <span id="lastUpdate">{{ last_update.strftime('%Y-%m-%d %H:%M') if last_update else '未知' }}</span>
                </div>
            </div>
        </div>

        <!-- 搜索表单区 -->
        <div class="filter-card">
            <form method="GET" action="{{ url_for('equipment_list') }}" id="searchForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-medium">固定资产编号</label>
                        <input type="text" class="form-control" name="fixed_asset_id" 
                               value="{{ request.args.get('fixed_asset_id', '') }}" placeholder="输入固定资产编号">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-medium">设备管理编号</label>
                        <input type="text" class="form-control" name="equipment_manage_id" 
                               value="{{ request.args.get('equipment_manage_id', '') }}" placeholder="输入设备管理编号">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-medium">仪器名称</label>
                        <input type="text" class="form-control" name="name" 
                               value="{{ request.args.get('name', '') }}" placeholder="输入仪器名称">
                    </div>
                    
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search me-1"></i> 搜索
                        </button>
                    </div>
                </div>
                
                <!-- 更多搜索条件 -->
                <div class="mt-3">
                    <button class="btn btn-outline-secondary p-0 collapse-toggle" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#moreFilters"
                            aria-expanded="false">
                        <i class="bi bi-chevron-down me-1"></i> 
                        <span>高级搜索条件</span>
                    </button>
                    <div class="collapse mt-3" id="moreFilters">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">型号</label>
                                <input type="text" class="form-control" name="model" 
                                       value="{{ request.args.get('model', '') }}" placeholder="输入仪器型号">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">实验室</label>
                                <select class="form-select" name="laboratory">
                                    <option value="">所有实验室</option>
                                    {% for lab in laboratories %}
                                    <option value="{{ lab }}" {% if request.args.get('laboratory') == lab %}selected{% endif %}>{{ lab }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">位置</label>
                                <input type="text" class="form-control" name="location" 
                                       value="{{ request.args.get('location', '') }}" placeholder="输入位置信息">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">状态</label>
                                <select class="form-select" name="status">
                                    <option value="">所有状态</option>
                                    <option value="正常" {% if request.args.get('status') == '正常' %}selected{% endif %}>正常</option>
                                    <option value="待检" {% if request.args.get('status') == '待检' %}selected{% endif %}>待检</option>
                                    <option value="维修中" {% if request.args.get('status') == '维修中' %}selected{% endif %}>维修中</option>
                                    <option value="已经维修" {% if request.args.get('status') == '已经维修' %}selected{% endif %}>已经维修</option>
                                    <option value="停用" {% if request.args.get('status') == '停用' %}selected{% endif %}>停用</option>
                                    <option value="报废中" {% if request.args.get('status') == '报废中' %}selected{% endif %}>报废中</option>
                                    <option value="报废" {% if request.args.get('status') == '报废' %}selected{% endif %}>报废</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- 操作按钮区 -->
        <div class="d-flex justify-content-between mb-3">
            <div>
                <a href="{{ url_for('add_equipment') }}" class="btn btn-success me-2 action-btn">
                    <i class="bi bi-plus-circle me-1"></i> 添加设备
                </a>
                <button class="btn btn-primary me-2 action-btn" id="importBtn" data-bs-toggle="modal" data-bs-target="#importExportModal">
                    <i class="bi bi-upload me-1"></i> 导入数据
                </button>
                <button class="btn btn-outline-primary me-2 action-btn" id="exportBtn">
                    <i class="bi bi-download me-1"></i> 导出数据
                </button>
            </div>
            <div>
                <a href="{{ url_for('equipment_monthly_report') }}" class="btn btn-info me-2 action-btn">
                    <i class="bi bi-clipboard-check me-1"></i> 月度检查表
                </a>
                <button class="btn btn-info action-btn" id="toggleViewBtn">
                    <i class="bi bi-grid me-1"></i> 切换视图
                </button>
                <button class="btn btn-outline-dark ms-2 action-btn" id="printCardsBtn">
                    <i class="bi bi-printer me-1"></i> 打印卡片
                </button>
            </div>
        </div>

        <!-- 设备列表区 -->
        {% if equipment.items %}
        <div class="table-container" id="tableView">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-table me-2"></i>设备列表（共 {{ equipment.total }} 条记录）</h4>
                <div>
                    <span class="badge bg-light text-dark">当前显示: {{ equipment.items|length }} 条记录</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" id="toggleSearchBar">
                        <i class="bi bi-search"></i> 搜索栏
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle" id="equipmentTable" data-retrieve="true">
                    <thead class="table-light">
                        <tr>
                            <th class="serial-column">序号</th>
                            <th>固定资产编号</th>
                            <th>设备管理编号</th>
                            <th>仪器名称</th>
                            <th>仪器型号</th>
                            <th>实验室</th>
                            <th>位置</th>
                            <th>状态</th>
                            <th>最近检查</th>
                            <th>年检日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in equipment.items %}
                        <tr>
                            <td class="text-center">{{ (equipment.page - 1) * equipment.per_page + loop.index }}</td>
                            <td>{{ item.fixed_asset_id }}</td>
                            <td>{{ item.equipment_manage_id }}</td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.model }}</td>
                            <td>{{ item.laboratory }}</td>
                            <td>{{ item.location }}</td>
                            <td>
                                <span class="status-badge 
                                    {% if item.status == '正常' %}status-normal
                                    {% elif item.status == '待检' %}status-pending
                                    {% elif item.status == '维修中' %}status-repairing
                                    {% elif item.status == '已经维修' %}status-repaired
                                    {% elif item.status == '停用' %}status-disabled
                                    {% elif item.status == '报废' %}status-scrapped
                                    {% elif item.status == '报废中' %}status-scrapping{% endif %}">
                                    {{ item.status }}
                                </span>
                            </td>
                            <td>{{ item.inspection_date.strftime('%Y-%m-%d') if item.inspection_date else '-' }}</td>
                            <td>{{ item.annual_check_date.strftime('%Y-%m-%d') if item.annual_check_date else '-' }}</td>
                            <td class="action-buttons">
                                <div class="action-btn-group">
                                    <a href="{{ url_for('view_equipment', id=item.id) }}" class="btn btn-info btn-sm action-btn">查看</a>
                                    <a href="{{ url_for('edit_equipment', id=item.id) }}" class="btn btn-warning btn-sm action-btn">编辑</a>
                                    <button class="btn btn-danger btn-sm delete-btn action-btn" 
                                            data-id="{{ item.id }}"
                                            data-name="{{ item.name }}">
                                        删除
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary action-btn dropdown-toggle" 
                                                type="button" 
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false"
                                                title="更多操作">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item preview-btn" 
                                                   href="#" 
                                                   data-id="{{ item.id }}"
                                                   data-bs-toggle="modal" 
                                                   data-bs-target="#previewModal">
                                                    <i class="bi bi-eye me-2"></i>预览详情
                                                </a>
                                            </li>
                                            
                                            <!-- 图片预览选项 -->
                                            {% if item.equipment_image %}
                                            <li>
                                                <a class="dropdown-item preview-image-btn" 
                                                   href="#" 
                                                   data-id="{{ item.id }}"
                                                   data-type="equipment_image">
                                                    <i class="bi bi-image me-2"></i>预览设备图片
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            {% if item.fixed_asset_image %}
                                            <li>
                                                <a class="dropdown-item preview-image-btn" 
                                                   href="#" 
                                                   data-id="{{ item.id }}"
                                                   data-type="fixed_asset_image">
                                                    <i class="bi bi-image me-2"></i>预览固定资产图片
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            {% if item.location_image %}
                                            <li>
                                                <a class="dropdown-item preview-image-btn" 
                                                   href="#" 
                                                   data-id="{{ item.id }}"
                                                   data-type="location_image">
                                                    <i class="bi bi-image me-2"></i>预览位置图片
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            <!-- 附件下载选项 -->
                                            {% if item.repair_attachment %}
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('download_equipment_attachment', id=item.id, type='repair_attachment') }}">
                                                    <i class="bi bi-tools me-2"></i>下载维修附件
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            {% if item.annual_check_attachment %}
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('download_equipment_attachment', id=item.id, type='annual_check_attachment') }}">
                                                    <i class="bi bi-clipboard-check me-2"></i>下载年检附件
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            {% if item.other_attachment %}
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('download_equipment_attachment', id=item.id, type='other_attachment') }}">
                                                    <i class="bi bi-file-earmark me-2"></i>下载其他附件
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            {% if item.manufacturer_manual_attachment %}
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('download_equipment_attachment', id=item.id, type='manufacturer_manual_attachment') }}">
                                                    <i class="bi bi-journal-text me-2"></i>下载原厂说明书
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            {% if item.sop_attachment %}
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('download_equipment_attachment', id=item.id, type='sop_attachment') }}">
                                                    <i class="bi bi-file-earmark-ruled me-2"></i>下载SOP文档
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            {% if item.calibration_record_attachment %}
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('download_equipment_attachment', id=item.id, type='calibration_record_attachment') }}">
                                                    <i class="bi bi-file-earmark-bar-graph me-2"></i>下载校准记录
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            {% if item.manufacturer_data_attachment %}
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('download_equipment_attachment', id=item.id, type='manufacturer_data_attachment') }}">
                                                    <i class="bi bi-file-earmark-medical me-2"></i>下载厂家资料
                                                </a>
                                            </li>
                                            {% endif %}
                                            
                                            <li>
                                                <a class="dropdown-item" href="{{ url_for('equipment_ai_query') }}?name={{ item.name }}&model={{ item.model }}">
                                                    <i class="bi bi-wifi me-2"></i>互联查询
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 分页导航 -->
            <nav aria-label="Page navigation" class="pagination-container mt-3">
                <ul class="pagination">
                    <li class="page-item {% if not equipment.has_prev %}disabled{% endif %}">
                        <a class="page-link" 
                           href="{{ url_for('equipment_list', 
                                  page=equipment.prev_num, 
                                  **request.args) }}">
                            <i class="bi bi-chevron-left"></i> 上一页
                        </a>
                    </li>
                    
                    {% for page_num in equipment.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=3) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == equipment.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('equipment_list', page=page_num, **request.args) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                    
                    <li class="page-item {% if not equipment.has_next %}disabled{% endif %}">
                        <a class="page-link" 
                           href="{{ url_for('equipment_list', 
                                  page=equipment.next_num, 
                                  **request.args) }}">
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <!-- 卡片视图区 -->
        <div class="table-container" id="cardView" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-grid me-2"></i>设备卡片视图（共 {{ equipment.total }} 台）</h4>
                <div>
                    <span class="badge bg-light text-dark">当前显示: {{ equipment.items|length }} 条记录</span>
                    <span class="badge bg-primary ms-2">高级条形码</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" id="sortByStatus">
                        <i class="bi bi-sort-alpha-down"></i> 按状态排序
                    </button>
                </div>
            </div>
            
               <div class="card-view">
                {% for item in equipment.items %}
                <div class="equipment-card" 
                     data-id="{{ item.id }}"
                     data-manage-id="{{ item.equipment_manage_id }}"
                     data-fixed-asset-id="{{ item.fixed_asset_id }}"
                     data-laboratory="{{ item.laboratory }}"
                     data-model="{{ item.model }}"
                     data-location="{{ item.location }}"
                     data-status="{{ item.status }}"
                     data-fault-history="{{ item.fault_history }}">
                    
                    <!-- 状态指示灯 -->
                    <div class="status-light 
                         {% if item.status == '正常' %}bg-success
                         {% elif item.status == '待检' %}bg-warning
                         {% elif item.status == '维修中' %}bg-danger
                         {% elif item.status == '已经维修' %}bg-primary
                         {% elif item.status == '停用' %}bg-secondary
                         {% elif item.status == '报废中' %}bg-purple
                         {% elif item.status == '报废' %}bg-dark{% endif %}">
                    </div>
                    
                    <div class="card-header">
                        <h5 class="mb-0">{{ item.name }}</h5>
                        <div class="text-white-50 small">{{ item.model }}</div>
                    </div>
                    
                    <div class="card-body">
                        <!-- 设备图片显示 -->
                        {% if item.equipment_image %}
                        <div class="text-center mb-3">
                            
                        </div>
                        {% else %}
                        <div class="equipment-image d-flex align-items-center justify-content-center bg-light rounded mb-3" style="height: 150px">
                            <i class="bi bi-camera fs-1 text-muted"></i>
                        </div>
                        {% endif %}
                        
                        <div class="card-property">
                            <span class="card-label">固定资产编号:</span>
                            <span class="card-value">{{ item.fixed_asset_id or '-' }}</span>
                        </div>
                        <div class="card-property">
                            <span class="card-label">管理编号:</span>
                            <span class="card-value">{{ item.equipment_manage_id or '-' }}</span>
                        </div>
                        <div class="card-property">
                            <span class="card-label">实验室:</span>
                            <span class="card-value">{{ item.laboratory or '-' }}</span>
                        </div>
                        <div class="card-property">
                            <span class="card-label">位置:</span>
                            <span class="card-value">{{ item.location or '-' }}</span>
                        </div>
                        <div class="card-property">
                            <span class="card-label">状态:</span>
                            <span class="card-value">
                                <span class="status-badge 
                                    {% if item.status == '正常' %}status-normal
                                    {% elif item.status == '待检' %}status-pending
                                    {% elif item.status == '维修中' %}status-repairing
                                    {% elif item.status == '已经维修' %}status-repaired
                                    {% elif item.status == '停用' %}status-disabled
                                    {% elif item.status == '报废中' %}status-scrapping
                                    {% elif item.status == '报废' %}status-scrapped{% endif %}">
                                    {{ item.status }}
                                </span>
                            </span>
                        </div>
                        <div class="card-property">
                            <span class="card-label">最近检查:</span>
                            <span class="card-value">{{ item.inspection_date.strftime('%Y-%m-%d') if item.inspection_date else '-' }}</span>
                        </div>
                        <div class="card-property">
                            <span class="card-label">年检日期:</span>
                            <span class="card-value">{{ item.annual_check_date.strftime('%Y-%m-%d') if item.annual_check_date else '-' }}</span>
                        </div>
                        
                        <!-- 故障历史记录 -->
                        {% if item.fault_history %}
                        <div class="mt-3">
                            <div class="card-label fw-medium">故障历史:</div>
                            <div class="fault-history">
                                {% for fault in item.fault_history.split(';') %}
                                    {% if fault %}
                                    <div class="fault-item">{{ fault }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                     <!-- 条形码区域（优化部分） -->
                    <div class="barcode-section">
                        <div class="barcode-container">
                            <!-- 使用逻辑确定条形码内容 -->
                            {% if item.fixed_asset_id %}
                                <canvas class="barcode-canvas" id="barcode-{{ item.id }}"></canvas>
                                <div class="barcode-value mt-2 text-center small">
                                    {{ item.fixed_asset_id }}
                                </div>
                            {% else %}
                                <canvas class="barcode-canvas" id="barcode-{{ item.id }}"></canvas>
                                <div class="barcode-value mt-2 text-center small">
                                    {{ item.equipment_manage_id }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="action-btn-group d-flex">
                            <a href="{{ url_for('view_equipment', id=item.id) }}" class="btn btn-sm btn-info flex-grow-1 action-btn">
                                <i class="bi bi-eye me-1"></i> 查看
                            </a>
                            <a href="{{ url_for('edit_equipment', id=item.id) }}" class="btn btn-sm btn-warning flex-grow-1 action-btn">
                                <i class="bi bi-pencil me-1"></i> 编辑
                            </a>
                            <button class="btn btn-danger btn-sm delete-btn flex-grow-1 action-btn" 
                                    data-id="{{ item.id }}"
                                    data-name="{{ item.name }}">
                                删除
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- 分页导航 -->
            <nav aria-label="Page navigation" class="pagination-container mt-4">
                <ul class="pagination">
                    <li class="page-item {% if not equipment.has_prev %}disabled{% endif %}">
                        <a class="page-link" 
                           href="{{ url_for('equipment_list', 
                                  page=equipment.prev_num, 
                                  **request.args) }}">
                            <i class="bi bi-chevron-left"></i> 上一页
                        </a>
                    </li>
                    
                    {% for page_num in equipment.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=3) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == equipment.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('equipment_list', page=page_num, **request.args) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                    
                    <li class="page-item {% if not equipment.has_next %}disabled{% endif %}">
                        <a class="page-link" 
                           href="{{ url_for('equipment_list', 
                                  page=equipment.next_num, 
                                  **request.args) }}">
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        {% else %}
        <div class="no-results text-center py-5">
            <div class="mb-3">
                <i class="bi bi-search" style="font-size: 3rem; color: #adb5bd;"></i>
            </div>
            <h4 class="text-muted mb-3">未找到符合条件的设备记录</h4>
            <p class="text-muted mb-4">请尝试修改搜索条件或添加新设备</p>
            <a href="{{ url_for('add_equipment') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i> 添加设备
            </a>
        </div>
        {% endif %}

        <!-- 浮动操作栏 -->
        <div class="floating-controls">
            <div class="floating-action-bar" id="floatingActionBar">
                <a href="{{ url_for('equipment_analysis') }}" class="btn btn-info me-2 action-btn">
            <i class="bi bi-graph-up me-1"></i> 设备运行分析
        </a>
                <a href="{{ url_for('equipment_ai_query') }}" class="btn btn-info action-btn">
                    <i class="bi bi-wifi me-1"></i> 互联查询
                </a>
            </div>
        </div>

        <!-- 密码确认模态框 -->
        <div class="modal fade password-modal" id="passwordConfirmModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">确认删除</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>您正在尝试删除设备 <strong id="equipmentNameToDelete"></strong></p>
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">请输入管理员密码</label>
                            <input type="password" class="form-control" id="adminPassword" required>
                        </div>
                        <input type="hidden" id="equipmentIdToDelete">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 预览模态框 - 增强版 -->
        <div class="modal fade preview-modal" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="previewModalLabel">设备详情预览</h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleScreenBtn">
                                <i class="bi bi-arrows-fullscreen"></i> 全屏
                            </button>
                            <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                    </div>
                    <div class="modal-body preview-modal-content" id="previewModalBody">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-3">正在加载设备信息...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图片预览模态框 -->
        <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imagePreviewLabel">图片预览</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        
                        <div id="imageName" class="mt-2 fw-bold"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <a id="downloadImageBtn" href="#" class="btn btn-primary">
                            <i class="bi bi-download me-1"></i> 下载图片
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 导入导出模态框 -->
        <div class="modal fade import-export-modal" id="importExportModal" tabindex="-1" aria-labelledby="importExportModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="importExportModalLabel">设备数据导入导出</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs mb-4" id="importExportTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="import-tab" data-bs-toggle="tab" data-bs-target="#import-tab-pane" type="button" role="tab" aria-controls="import-tab-pane" aria-selected="true">
                                    <i class="bi bi-upload me-2"></i> 导入数据
                                </button>
                            </li>
                          
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-tab-pane" type="button" role="tab" aria-controls="export-tab-pane" aria-selected="false">
                                     <i class="bi bi-download me-2"></i> 导出数据
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="importExportTabsContent">
                            <!-- 导入标签页 -->
                            <div class="tab-pane fade show active" id="import-tab-pane" role="tabpanel" aria-labelledby="import-tab" tabindex="0">
                                <div class="mb-4">
                                    <h5><i class="bi bi-file-earmark-arrow-down me-2"></i>下载导入模板</h5>
                                    <p class="text-muted">请选择模板格式并下载</p>
                                    <div class="d-flex gap-2 mb-3">
                                        <a href="{{ url_for('download_equipment_template') }}" 
                                           class="btn btn-outline-primary flex-grow-1">
                                            <i class="bi bi-filetype-xlsx"></i> Excel 模板
                                        </a>
                                        <a href="{{ url_for('download_equipment_template', format='csv') }}" 
                                           class="btn btn-outline-primary flex-grow-1">
                                            <i class="bi bi-filetype-csv"></i> CSV 模板
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h5><i class="bi bi-cloud-arrow-up me-2"></i>上传数据文件</h5>
                                    <p class="text-muted">支持Excel (.xlsx) 和 CSV (.csv) 格式文件</p>
                                    
                                    <form id="importForm" action="{{ url_for('import_equipment') }}" method="post" enctype="multipart/form-data">
                                        <div id="fileDropArea" class="file-drop-area p-4 border rounded text-center">
                                            <i class="bi bi-cloud-arrow-up fs-1 text-muted mb-2"></i>
                                            <p class="mb-1">拖放文件到此处或点击上传</p>
                                            <p class="text-muted small mb-0">支持Excel和CSV格式</p>
                                            <input type="file" id="fileInput" name="file" class="file-input d-none">
                                            <button type="button" class="btn btn-sm btn-outline-primary mt-3" id="browseFileBtn">
                                                <i class="bi bi-folder2-open me-1"></i> 浏览文件
                                            </button>
                                            <div id="fileList" class="mt-3"></div>
                                        </div>
                                        <div class="mt-3 d-flex justify-content-end">
                                            <button type="submit" class="btn btn-primary" id="submitImport">
                                                <i class="bi bi-upload me-1"></i> 开始导入
                                            </button>
                                     </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- 导出标签页 -->
                            <div class="tab-pane fade" id="export-tab-pane" role="tabpanel" aria-labelledby="export-tab" tabindex="0">
                                <div class="mb-4">
                                    <h5><i class="bi bi-file-earmark-arrow-up me-2"></i>导出设备数据</h5>
                                    <p class="text-muted">选择导出格式、范围并指定保存位置</p>
                                    
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">导出格式</label>
                                            <select class="form-select" id="exportFormat">
                                                <option value="xlsx">Excel 文件 (.xlsx)</option>
                                                <option value="csv">CSV 文件 (.csv)</option>
                                                <option value="barcode">条形码卡片 (.pdf)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">导出范围</label>
                                            <select class="form-select" id="exportScope">
                                                <option value="all">所有数据</option>
                                                <option value="current">当前搜索结果</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-12">
                                            <label class="form-label">保存位置</label>
                                            <div class="export-path">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span id="exportPathDisplay">默认下载位置</span>
                                                    <button class="btn btn-sm btn-outline-secondary" id="browseFolderBtn">
                                                        <i class="bi bi-folder"></i> 浏览
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="form-text mt-2">默认下载到浏览器默认下载位置</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 d-flex justify-content-end">
                                        <button class="btn btn-primary" id="startExport">
                                            <i class="bi bi-download me-1"></i> 开始导出
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 打印容器 -->
    <div class="print-container d-none">
        <div id="printCardsArea"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // 初始化函数
        document.addEventListener('DOMContentLoaded', function() {
            // 1. 视图切换功能
            let currentView = localStorage.getItem('equipmentView') || 'table';
            applyView(currentView);
            
            // 2. 导出功能
            $('#exportBtn').on('click', function() {
                // 打开导入导出模态框并切换到导出标签
                const modal = new bootstrap.Modal(document.getElementById('importExportModal'));
                modal.show();
                $('#importExportTabs button[data-bs-target="#export-tab-pane"]').tab('show');
            });
            
            // 3. 打印卡片功能
            $('#printCardsBtn').on('click', printEquipmentCards);

            // 视图切换功能实现
            function applyView(view) {
                if (view === 'table') {
                    $('#tableView').show();
                    $('#cardView').hide();
                    $('#toggleViewBtn').html('<i class="bi bi-grid me-1"></i> 卡片视图');
                } else {
                    $('#tableView').hide();
                    $('#cardView').show();
                    $('#toggleViewBtn').html('<i class="bi bi-table me-1"></i> 表格视图');
                    
                    // 生成条形码
                    generateBarcodes();
                    
                    // 添加动画效果
                    animateCards();
                }
                localStorage.setItem('equipmentView', view);
            }
            
            // 导出功能实现
            $('#startExport').on('click', function() {
                const formatType = $('#exportFormat').val();
                const scope = $('#exportScope').val();
                
                // 构建导出URL
                let url = '/export_equipment?';
                url += `format=${formatType}`;
                url += `&scope=${scope}`;
                
                // 添加搜索参数
                const params = new URLSearchParams(window.location.search);
                if (scope === 'current') {
                    for (const [key, value] of params.entries()) {
                        if (key !== 'page') {
                            url += `&${key}=${encodeURIComponent(value)}`;
                        }
                    }
                }
                
                // 特殊处理条形码卡片
                if (formatType === 'barcode') {
                    printEquipmentCards();
                } else {
                    // 触发文件下载
                    window.location.href = url;
                }
            });
            
            // 打印卡片功能实现
            function printEquipmentCards() {
                const cards = $('#cardView .equipment-card:visible');
                
                if (cards.length === 0) {
                    alert('没有可打印的设备卡片');
                    return;
                }
                
                // 创建打印容器
                const printContainer = $('#printCardsArea').empty();
                
                // 复制卡片到打印容器
                cards.each(function(index) {
                    const $card = $(this);
                    const id = $card.data('id');
                    const manageId = $card.data('manage-id') || '';
                    const fixedAssetId = $card.data('fixed-asset-id') || '';
                    const name = $card.find('.card-header h5').text();
                    const model = $card.find('.card-header .small').text();
                    const location = $card.find('.card-property:contains("位置:") .card-value').text() || '-';
                    const status = $card.find('.card-property:contains("状态:") .card-value .status-badge').text();
                    const inspectionDate = $card.find('.card-property:contains("最近检查:") .card-value').text() || '-';
                    
                    const printCard = $(`
                        <div class="print-card">
                            <div class="print-header">
                                <div class="print-title">设备信息卡</div>
                            </div>
                            <div class="print-body">
                                <div class="print-row">
                                    <span class="print-label">名称:</span>
                                    <span class="print-value">${name}</span>
                                </div>
                                <div class="print-row">
                                    <span class="print-label">型号:</span>
                                    <span class="print-value">${model}</span>
                                </div>
                                <div class="print-row">
                                    <span class="print-label">管理编号:</span>
                                    <span class="print-value">${manageId}</span>
                                </div>
                                <div class="print-row">
                                    <span class="print-label">资产编号:</span>
                                    <span class="print-value">${fixedAssetId}</span>
                                </div>
                                <div class="print-row">
                                    <span class="print-label">位置:</span>
                                    <span class="print-value">${location}</span>
                                </div>
                                <div class="print-row">
                                    <span class="print-label">状态:</span>
                                    <span class="print-value">
                                        <span class="print-status 
                                            ${status === '正常' ? 'status-normal' : 
                                              status === '待检' ? 'status-pending' : 
                                              status === '维修中' ? 'status-repairing' : 
                                              status === '已经维修' ? 'status-repaired' : 
                                              status === '停用' ? 'status-disabled' : 
                                              status === '报废中' ? 'status-scrapping' : 
                                              'status-scrapped'}">${status}
                                        </span>
                                    </span>
                                </div>
                                <div class="print-row">
                                    <span class="print-label">最近检查:</span>
                                    <span class="print-value">${inspectionDate}</span>
                                </div>
                            </div>
                            <canvas class="print-barcode" id="print-barcode-${id}"></canvas>
                            <div class="print-date">打印日期: ${new Date().toLocaleDateString()}</div>
                        </div>
                    `);
                    
                    printContainer.append(printCard);
                    
                    // 生成打印条形码
                    setTimeout(() => {
                        const barcodeContent = `ID:${id}|管理号:${manageId}|资产号:${fixedAssetId}|名称:${name}`;
                        const canvas = printCard.find('.print-barcode')[0];
                        
                        try {
                            JsBarcode(canvas, barcodeContent, {
                                format: "CODE128",
                                displayValue: false,
                                height: 20,
                                margin: 0,
                                background: "transparent"
                            });
                        } catch (e) {
                            console.error(`打印条形码生成失败: ${e.message}`);
                        }
                    }, 100);
                });
                
                // 显示打印区域
                $('.print-container').removeClass('d-none');
                
                // 打印功能
                setTimeout(() => {
                    window.print();
                    
                    // 隐藏打印区域
                    setTimeout(() => $('.print-container').addClass('d-none'), 500);
                }, 500);
            }

            // 视图切换按钮事件
            $('#toggleViewBtn').on('click', function() {
                const currentView = localStorage.getItem('equipmentView') || 'table';
                const newView = currentView === 'table' ? 'card' : 'table';
                applyView(newView);
            });
            
            // 图片预览按钮事件
            $('body').on('click', '.preview-image-btn', function(e) {
                e.preventDefault();
                const equipmentId = $(this).data('id');
                const imageType = $(this).data('type');
                
                // 获取图片URL
                const url = `/download_equipment_attachment/${equipmentId}/${imageType}`;
                
                // 设置模态框内容
                $('#previewImage').attr('src', url);
                $('#imageName').text($(this).text().replace('预览', ''));
                $('#downloadImageBtn').attr('href', url);
                
                // 显示图片预览模态框
                const imageModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
                imageModal.show();
            });
            
            // 预览按钮点击事件
            $('body').on('click', '.preview-btn', function() {
                const equipmentId = $(this).data('id');
                
                // 显示加载指示器
                $('#previewModalBody').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div><p class="mt-3">正在加载设备信息...</p></div>');
                
                // 发送AJAX请求
                $.get(`/equipment_details/${equipmentId}`, function(data) {
                    renderPreviewContent(data);
                }).fail(function() {
                    $('#previewModalBody').html('<div class="alert alert-danger">加载设备信息失败</div>');
                });
            });
            
            // 渲染预览内容
            function renderPreviewContent(data) {
                let content = `
                    <div class="preview-modal-content">
                        <div class="mb-4">
                            <h4 class="mb-3">${data.name} (${data.model})</h4>
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge ${data.status_class} me-2">${data.status}</span>
                                <span>管理编号: ${data.equipment_manage_id || '-'}</span>
                            </div>
                        </div>
                        
                        <!-- 设备图片预览 -->
                        <div class="mb-4">
                            <h5><i class="bi bi-images me-2"></i>设备图片</h5>
                            <div class="d-flex flex-wrap">`;
                
                // 添加图片预览
                if (data.equipment_image) {
                    content += `
                        <div class="me-3 mb-3">
                            <a href="${data.equipment_image}" target="_blank" class="d-block">
                                
                            </a>
                            <div class="text-center mt-1">设备图片</div>
                        </div>`;
                }
                
                if (data.fixed_asset_image) {
                    content += `
                        <div class="me-3 mb-3">
                            <a href="${data.fixed_asset_image}" target="_blank" class="d-block">
                                
                            </a>
                            <div class="text-center mt-1">资产图片</div>
                        </div>`;
                }
                
                if (data.location_image) {
                    content += `
                        <div class="me-3 mb-3">
                            <a href="${data.location_image}" target="_blank" class="d-block">
                                
                            </a>
                            <div class="text-center mt-1">位置图片</div>
                        </div>`;
                }
                
                content += `</div></div>`;
                
                // 设备基本信息
                content += `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">基本信息</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <th width="40%">固定资产编号</th>
                                            <td>${data.fixed_asset_id || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>实验室</th>
                                            <td>${data.laboratory || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>位置</th>
                                            <td>${data.location || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>最近检查</th>
                                            <td>${data.inspection_date || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>年检日期</th>
                                            <td>${data.annual_check_date || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>购买日期</th>
                                            <td>${data.purchase_date || '-'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">维护信息</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <th width="40%">故障类别</th>
                                            <td>${data.fault_category || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>处理方法</th>
                                            <td>${data.handling_method || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>解决方案</th>
                                            <td>${data.solution || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>完成日期</th>
                                            <td>${data.completion_date || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>操作员</th>
                                            <td>${data.operator || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>确认人</th>
                                            <td>${data.confirmer || '-'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                // 故障历史记录
                if (data.fault_history) {
                    content += `
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">故障历史记录</h5>
                            </div>
                            <div class="card-body">
                                <pre class="fault-history">${data.formatted_fault_history}</pre>
                            </div>
                        </div>`;
                }
                
                // 备注信息
                if (data.notes) {
                    content += `
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">备注信息</h5>
                            </div>
                            <div class="card-body">
                                <p>${data.notes}</p>
                            </div>
                        </div>`;
                }
                
                content += `</div>`;
                
                $('#previewModalBody').html(content);
            }
            
            // 初始化日期显示
            const now = new Date();
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });

            // 生成条形码函数（优化部分）
        function generateBarcodes() {
            $('.equipment-card').each(function() {
                const $card = $(this);
                const id = $card.data('id');
                const manageId = $card.data('manage-id') || '';
                const fixedAssetId = $card.data('fixed-asset-id') || '';

               // 确定条形码内容
                const barcodeContent = fixedAssetId ? fixedAssetId : manageId;
                
                const canvas = $card.find('.barcode-canvas')[0];
                try {
                    if (barcodeContent) {
                        JsBarcode(canvas, barcodeContent, {
                            format: "CODE128",
                            displayValue: false,
                            fontSize: 12,
                            height: 40,
                            margin: 5,
                            background: "#ffffff"
                        });
                    } else {
                        canvas.innerHTML = `<span class="text-muted">无可用编号</span>`;
                    }
                } catch (e) {
                    console.error(`生成条形码失败: ${e.message}`);
                    canvas.innerHTML = `<span class="text-muted">条形码生成失败</span>`;
                }
            });
        }
                    
                   // 数据库查询优化
        function optimizeDatabaseQueries() {
            // 添加索引
            db.session.execute('CREATE INDEX IF NOT EXISTS idx_equipment_fixed_asset ON equipment(fixed_asset_id)');
            db.session.execute('CREATE INDEX IF NOT EXISTS idx_equipment_manage ON equipment(equipment_manage_id)');
            
            // 缓存常用查询
            const cache = new Map();
            
            function getEquipmentWithCache(id) {
                if (cache.has(id)) {
                    return cache.get(id);
                }
                
                const item = Equipment.query.get(id);
                cache.set(id, item);
                return item;
            }
            
            // 批量查询优化
            function batchGetEquipment(ids) {
                return Equipment.query.filter(Equipment.id.in_(ids)).all();
            }
        }  
            
            // 卡片动画
            function animateCards() {
                $('.equipment-card').each(function(i) {
                    $(this).css({
                        'animation-delay': `${i * 0.1}s`,
                        'opacity': 0
                    }).animate({opacity: 1}, 500);
                });
            }
            
            // 暗黑模式切换
            $('#themeToggle').on('click', function() {
                const isDarkMode = document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', isDarkMode);
                
                if (isDarkMode) {
                    $(this).html('<i class="bi bi-sun me-1"></i> 亮色模式');
                } else {
                    $(this).html('<i class="bi bi-moon-stars me-1"></i> 暗黑模式');
                }
            });
            
            // 删除按钮事件
            $('body').on('click', '.delete-btn', function(e) {
                e.preventDefault();
                const id = $(this).data('id');
                const name = $(this).data('name');
                
                // 设置模态框中的设备名称
                $('#equipmentNameToDelete').text(name);
                $('#equipmentIdToDelete').val(id);
                
                // 显示模态框
                const passwordModal = new bootstrap.Modal(document.getElementById('passwordConfirmModal'));
                passwordModal.show();
            });
            
            // 确认删除按钮
            $('#confirmDeleteBtn').on('click', function() {
                const password = $('#adminPassword').val();
                const id = $('#equipmentIdToDelete').val();
                
                if (!password) {
                    alert('请输入管理员密码');
                    return;
                }
                
                // 提交删除请求
                $.ajax({
                    url: `/delete_equipment/${id}`,
                    type: 'POST',
                    data: { password: password },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.message || '删除失败');
                        }
                    },
                    error: function() {
                        alert('服务器错误，请稍后重试');
                    }
                });
            });
            
            // 卡片视图按状态排序
            $('#sortByStatus').on('click', function() {
                const $container = $('.card-view');
                const $cards = $container.children('.equipment-card');
                
                $cards.sort(function(a, b) {
                    const statusA = $(a).data('status');
                    const statusB = $(b).data('status');
                    const statusOrder = {
                        '正常': 1, 
                        '待检': 2, 
                        '已经维修': 3, 
                        '维修中': 4, 
                        '停用': 5, 
                        '报废中': 6, 
                        '报废': 7
                    };
                    
                    return statusOrder[statusA] - statusOrder[statusB];
                });
                
                $container.append($cards);
            });
            
            // 文件上传处理
            $('#browseFileBtn').on('click', function() {
                $('#fileInput').click();
            });
            
            $('#fileInput').on('change', function() {
                const file = this.files[0];
                if (file) {
                    $('#fileList').html(`
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            <div>
                                <strong>${file.name}</strong><br>
                                <small>${(file.size / 1024).toFixed(2)} KB</small>
                            </div>
                        </div>
                    `);
                }
            });
            
            // 高亮搜索关键词
            function highlightSearchTerms() {
                const params = new URLSearchParams(window.location.search);
                const searchTerms = {
                    fixed_asset_id: params.get('fixed_asset_id'),
                    equipment_manage_id: params.get('equipment_manage_id'),
                    name: params.get('name'),
                    model: params.get('model'),
                    laboratory: params.get('laboratory'),
                    location: params.get('location')
                };
                
                for (const [key, value] of Object.entries(searchTerms)) {
                    if (value) {
                        const regex = new RegExp(value, 'gi');
                        const elements = document.querySelectorAll(`.card-value, td`);
                        
                        elements.forEach(el => {
                            if (el.textContent.match(regex)) {
                                const highlighted = el.innerHTML.replace(
                                    regex, 
                                    match => `<span class="search-highlight">${match}</span>`
                                );
                                el.innerHTML = highlighted;
                            }
                        });
                    }
                }
            }
            
            highlightSearchTerms();
            
            // 初始化暗黑模式
            function initDarkMode() {
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').innerHTML = '<i class="bi bi-sun me-1"></i> 亮色模式';
                }
            }
            
            initDarkMode();
            
            // 初始化DataTable
            function initDataTable() {
                const table = $('#equipmentTable').DataTable({
                    paging: false,
                    searching: false,
                    info: false,
                    ordering: true,
                    retrieve: true,
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-CN.json'
                    },
                    scrollY: '55vh',
                    scrollCollapse: true,
                    autoWidth: true,
                    columnDefs: [
                        { orderable: false, targets: [0, 10] }
                    ]
                });
                
                // 表格搜索栏切换
                $('#toggleSearchBar').on('click', function() {
                    $('.dataTables_filter').toggle();
                    $(this).find('i').toggleClass('bi-search bi-search');
                });
            }
            
            initDataTable();
        });
    </script>
</body>
</html>