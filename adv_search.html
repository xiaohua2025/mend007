<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级查询 - 化学品管理系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white;
            padding: 1.5rem 0;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .table-responsive { 
            max-height: 70vh;
            overflow-x: auto;
        }
        
        .search-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: none;
        }
        
        .batch-actions {
            background: var(--light-bg);
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-top: 1.5rem;
            display: none;
            border-left: 4px solid var(--secondary-color);
        }
        
        .batch-actions.show {
            display: block;
        }
        
        .highlight-result {
            background-color: rgba(231, 76, 60, 0.08);
            transition: background 0.3s ease;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .status-expiring { background-color: #f39c12; }
        .status-low { background-color: #e74c3c; }
        .status-normal { background-color: #2ecc71; }
        
        .action-result {
            min-height: 1.5rem;
            font-size: 0.9rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .resizable-table {
            table-layout: fixed;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .resizable-table th {
            position: relative;
            background-color: #f1f5f9;
            font-weight: 600;
            color: var(--primary-color);
            padding: 0.85rem 1rem;
        }
        
        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: rgba(52, 152, 219, 0.3);
            cursor: col-resize;
            transition: background 0.2s;
        }
        
        .resize-handle:hover, .resize-handle.active {
            background: var(--secondary-color);
        }
        
        .table th, .table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0.75rem 1rem;
            vertical-align: middle;
            border-top: 1px solid var(--border-color);
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(241, 245, 249, 0.4);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .table-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
        }
        
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-action {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .btn-group-sm .btn {
            padding: 0.4rem 0.75rem;
        }
        
        .btn-group-vertical {
            flex-direction: column;
        }
        
        .preview-modal .modal-content {
            background-color: rgba(0,0,0,0.85);
        }
        
        .preview-modal .modal-header {
            border-bottom: 1px solid #444;
        }
        
        .preview-modal .modal-body {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }
        
        .preview-modal .modal-footer {
            border-top: 1px solid #444;
            justify-content: space-between;
        }
        
        .preview-modal img {
            max-height: 75vh;
            max-width: 100%;
            object-fit: contain;
        }
        
        .preview-modal .size-controls .btn {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-modal .btn-fullscreen {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1060;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
        }
        
        .preview-modal .btn-fullscreen:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .badge-status {
            font-weight: 500;
            padding: 0.35em 0.65em;
            border-radius: 10px;
            font-size: 0.75em;
        }
        
        .badge-in {
            background-color: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }
        
        .badge-out {
            background-color: rgba(231, 76, 60, 0.15);
            color: #c0392b;
        }
        
        .badge-check {
            background-color: rgba(52, 152, 219, 0.15);
            color: #2980b9;
        }
        
        .no-results {
            background-color: rgba(241, 245, 249, 0.7);
            border-radius: 8px;
            padding: 3rem 1rem;
            text-align: center;
        }
        
        .chemical-row {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .chemical-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .chemical-info-popover {
            max-width: 400px;
        }
        
        .sort-indicator {
            color: #4361ee;
            margin-left: 5px;
            font-size: 0.9em;
        }
        
        .search-params {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }
        
        .search-param-item {
            background: #e9ecef;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.9rem;
        }
        
        .param-label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        /* 新增样式：克隆记录按钮 */
        .clone-record-btn {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .clone-record-btn:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
    </style>
</head>
<body>
    <!-- 图片预览模态框 -->
    <div class="modal fade preview-modal" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-light">化学品图片预览</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="previewImage" src="" alt="化学品图片" style="display: none;">
                    <button id="fullscreenBtn" class="btn btn-light btn-fullscreen" title="切换全屏">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
                <div class="modal-footer">
                    <div class="size-controls">
                        <button class="btn btn-secondary btn-sm" onclick="changePreviewSize('small')">
                            <i class="bi bi-aspect-ratio"></i> 小屏
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="changePreviewSize('medium')">
                            <i class="bi bi-aspect-ratio"></i> 中屏
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="changePreviewSize('large')">
                            <i class="bi bi-aspect-ratio"></i> 大屏
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-info btn-sm" onclick="rotateImage(-90)">
                            <i class="bi bi-arrow-counterclockwise"></i> 左转
                        </button>
                        <button class="btn btn-info btn-sm" onclick="rotateImage(90)">
                            <i class="bi bi-arrow-clockwise"></i> 右转
                        </button>
                        <a id="downloadLink" class="btn btn-success btn-sm" download>
                            <i class="bi bi-download"></i> 下载
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 化学品信息弹出框 -->
    <div class="popover chemical-info-popover" role="tooltip">
        <div class="popover-arrow"></div>
        <div class="popover-header"></div>
        <div class="popover-body"></div>
    </div>

    <!-- 标题栏 -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0"><i class="bi bi-search-heart me-2"></i>高级查询结果</h1>
                <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i> 返回首页
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 查询条件展示 -->
        <div class="search-card">
            <div class="d-flex align-items-center mb-3">
                <i class="bi bi-funnel fs-4 me-2 text-primary"></i>
                <h5 class="mb-0">当前查询条件</h5>
            </div>
            
            <div class="search-params">
                {% if search_params.name %}
                <div class="search-param-item">
                    <span class="param-label">化学品名称:</span> 
                    <span>{{ search_params.name }}</span>
                </div>
                {% endif %}
                
                {% if search_params.code %}
                <div class="search-param-item">
                    <span class="param-label">商品代码:</span> 
                    <span>{{ search_params.code }}</span>
                </div>
                {% endif %}
                
                {% if search_params.cas %}
                <div class="search-param-item">
                    <span class="param-label">CAS编号:</span> 
                    <span>{{ search_params.cas }}</span>
                </div>
                {% endif %}
                
                <div class="search-param-item">
                    <span class="param-label">匹配模式:</span> 
                    <span>{{ '模糊匹配' if search_params.fuzzy else '精确匹配' }}</span>
                </div>
                
                <div class="search-param-item">
                    <span class="param-label">结果数量:</span> 
                    <span>{{ chemicals|length }} 条记录</span>
                </div>
                
                <div class="search-param-item">
                    <span class="param-label">排序方式:</span> 
                    <span>收支日期（最新优先）</span>
                </div>
            </div>
        </div>

        <!-- 表格工具栏 -->
        <div class="table-toolbar">
            <div class="d-flex align-items-center">
                <div class="form-check form-switch me-3">
                    <input class="form-check-input" type="checkbox" id="flexibleWidthSwitch" checked>
                    <label class="form-check-label" for="flexibleWidthSwitch">列宽调整</label>
                </div>
                
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="compactViewSwitch">
                    <label class="form-check-label" for="compactViewSwitch">紧凑视图</label>
                </div>
            </div>
            
            <div class="table-actions">
                <button class="btn btn-outline-primary btn-sm" onclick="resetColumnWidths()">
                    <i class="bi bi-arrow-repeat me-1"></i>重置列宽
                </button>
                
                <!-- 新添加的复制新记录按钮 -->
                <button id="cloneRecordBtn" class="btn btn-success btn-sm clone-record-btn" disabled onclick="cloneSelectedRecord()">
                    <i class="bi bi-files me-1"></i>复制新记录
                </button>
                
                <div class="dropdown">
                    <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-download me-1"></i>导出数据
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportData('csv')">CSV格式</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportData('excel')">Excel格式</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportData('pdf')">PDF格式</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 结果表格 -->
        <div class="table-responsive rounded shadow-sm">
            <table class="table table-hover table-striped align-middle resizable-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th style="width: 160px;">化学品名称</th>
                        <th style="width: 110px;">商品代码</th>
                        <th style="width: 100px;">CAS编号</th>
                        <th style="width: 130px;">规格型号</th>
                        <th style="width: 100px;">批次号</th>
                        <th style="width: 90px;">操作类型</th>
                        <th style="width: 90px;">操作数量</th>
                        <th style="width: 90px;">库存量</th>
                        <th style="width: 100px;">耗材类别</th>
                        <th style="width: 100px;">仓库位置</th>
                        <th style="width: 100px;">监管类别</th>
                        <th style="width: 100px;">
                            收支日期
                            <i class="bi bi-sort-down sort-indicator" title="按最新日期排序"></i>
                        </th>
                        <th style="width: 100px;">有效期</th>
                        <th style="width: 450px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% if chemicals %}
                        {% for chem in chemicals %}
                        <tr class="chemical-row" data-id="{{ chem.id }}">
                            <td>
                                <input type="checkbox" class="chemical-checkbox" 
                                       data-id="{{ chem.id }}"
                                       data-name="{{ chem.name }}"
                                       data-code="{{ chem.product_code }}">
                            </td>
                            <td>
                                <span class="d-flex align-items-center">
                                    {{ chem.name }}
                                    <i class="bi bi-info-circle ms-2 text-primary info-icon" 
                                       data-bs-toggle="popover"
                                       title="{{ chem.name }} - 详细信息"
                                       data-content="
                                           <div class='mb-2'><strong>供应商:</strong> {{ chem.supplier or '未记录' }}</div>
                                           <div class='mb-2'><strong>生产商:</strong> {{ chem.manufacturer or '未记录' }}</div>
                                           <div><strong>安全等级:</strong> {{ chem.regulatory_category or '未分类' }}</div>
                                       "></i>
                                </span>
                            </td>
                            <td>{{ chem.product_code }}</td>
                            <td>{{ chem.cas_number or '' }}</td>
                            <td>{{ chem.specification }} {{ chem.model }}</td>
                            <td>{{ chem.batch_number }}</td>
                            <td>
                                <span class="badge badge-status 
                                    {% if chem.action == '入库' %}badge-in{% elif chem.action == '出库' %}badge-out{% else %}badge-check{% endif %}">
                                    {{ chem.action }}
                                </span>
                            </td>
                            <td class="text-end">{{ chem.quantity }}</td>
                            <td class="text-end">{{ chem.total_stock }}</td>
                            <td>{{ chem.consumable_category or '' }}</td>
                            <td>{{ chem.warehouse_location or '' }}</td>
                            <td>{{ chem.regulatory_category or '' }}</td>
                            <td>{{ chem.production_date.strftime('%Y-%m-%d') if chem.production_date else '' }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {{ chem.expiration_date.strftime('%Y-%m-%d') if chem.expiration_date else '' }}
                                    {% if chem.days_remaining is not none and chem.days_remaining <= 30 %}
                                        <span class="status-indicator status-expiring ms-1" 
                                              title="剩余 {{ chem.days_remaining }} 天"></span>
                                    {% elif chem.days_remaining is not none and chem.days_remaining > 30 %}
                                        <span class="status-indicator status-normal ms-1" 
                                              title="剩余 {{ chem.days_remaining }} 天"></span>
                                    {% endif %}
                                </div>
                            </td>
<td>
    <div class="btn-group btn-group-sm" role="group">
        <!-- 编辑按钮 -->
        <a href="{{ url_for('edit_chemical', id=chem.id) }}" 
           class="btn btn-outline-primary"
           title="编辑"
           data-bs-toggle="tooltip">
            <i class="bi bi-pencil"></i>
        </a>
        
        <!-- 查看详情按钮 -->
        <a href="{{ url_for('view_chemical', id=chem.id) }}"
           class="btn btn-outline-info"
           title="查看详情"
           data-bs-toggle="tooltip">
            <i class="bi bi-info-circle"></i>
        </a>
        
        <!-- 复制新记录按钮 -->
        <a href="{{ url_for('clone_chemical', id=chem.id) }}"
           class="btn btn-outline-warning"
           title="复制新记录"
           data-bs-toggle="tooltip">
            <i class="bi bi-files"></i>
        </a>
        
        <!-- 预览图片按钮（如果有图片） -->
        {% if chem.image %}
        <button class="btn btn-outline-secondary preview-btn"
                data-image-url="{{ url_for('view_image', id=chem.id) }}"
                title="预览图片"
                data-bs-toggle="tooltip">
            <i class="bi bi-eye"></i>
        </button>
        {% endif %}
        
        <!-- 下载附件按钮（如果有附件） -->
        {% if chem.attachment %}
        <a href="{{ url_for('download_attachment', id=chem.id, type='attachment') }}"
           class="btn btn-outline-success"
           title="下载附件"
           data-bs-toggle="tooltip">
            <i class="bi bi-download"></i>
        </a>
        {% endif %}
        
        <!-- 更多操作下拉菜单 -->
        <div class="btn-group dropend">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                    data-bs-toggle="dropdown" aria-expanded="false"
                    title="更多操作"
                    data-bs-toggle="tooltip">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <!-- 送货单 -->
                {% if chem.delivery_order_attachment %}
                <li>
                    <a class="dropdown-item" href="{{ url_for('download_attachment', id=chem.id, type='delivery_order') }}">
                        <i class="bi bi-truck me-2"></i>下载送货单
                    </a>
                </li>
                {% endif %}
                
                <!-- 发票 -->
                {% if chem.invoice_attachment %}
                <li>
                    <a class="dropdown-item" href="{{ url_for('download_attachment', id=chem.id, type='invoice') }}">
                        <i class="bi bi-receipt me-2"></i>下载发票
                    </a>
                </li>
                {% endif %}
                
                <!-- 删除记录 -->
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item text-danger" href="#" onclick="confirmDelete({{ chem.id }})">
                        <i class="bi bi-trash me-2"></i>删除记录
                    </a>
                </li>
            </ul>
        </div>
    </div>
</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="15" class="no-results">
                                <i class="bi bi-database-exclamation fs-1 text-muted"></i>
                                <h5 class="mt-3 text-muted">未找到匹配的化学品记录</h5>
                                <p class="text-muted mb-0">请尝试不同的搜索条件或返回首页</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- 批量操作面板 -->
        <div id="batchOperations" class="batch-actions">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>批量操作</h5>
                <span class="text-muted action-result" id="actionResult"></span>
            </div>
            
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary me-2" onclick="executeBatchAction('all')">
                    <i class="bi bi-card-checklist me-1"></i> 全部记录
                </button>
                <button class="btn btn-primary me-2" onclick="executeBatchAction('in')">
                    <i class="bi bi-box-arrow-in-down me-1"></i> 入库记录
                </button>
                <button class="btn btn-primary me-2" onclick="executeBatchAction('out')">
                    <i class="bi bi-box-arrow-up me-1"></i> 出库记录
                </button>
                <button class="btn btn-primary me-2" onclick="executeBatchAction('check')">
                    <i class="bi bi-clipboard-check me-1"></i> 盘点记录
                </button>
                <button class="btn btn-primary me-2" onclick="executeBatchAction('last')">
                    <i class="bi bi-clock-history me-1"></i> 最后收货记录
                </button>
            </div>
        </div>

        <!-- 结果容器 -->
        <div id="resultContainer" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 图片预览相关变量
        let previewModal = null;
        let currentRotation = 0;
        let currentSize = 'medium';
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化工具提示
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            
            // 初始化弹出框
            const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(popoverTriggerEl => {
                new bootstrap.Popover(popoverTriggerEl, {
                    container: 'body',
                    html: true,
                    trigger: 'hover focus'
                });
            });
            
            const checkboxes = document.querySelectorAll('.chemical-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateBatchPanel);
            });
            
            // 初始化可调整列宽功能
            setupResizableColumns();
            
            // 监听可调整列宽开关
            document.getElementById('flexibleWidthSwitch').addEventListener('change', function() {
                if (this.checked) {
                    enableColumnResizing();
                } else {
                    disableColumnResizing();
                }
            });
            
            // 监听紧凑视图开关
            document.getElementById('compactViewSwitch').addEventListener('change', function() {
                const table = document.querySelector('.table');
                table.classList.toggle('table-sm');
            });
            
            // 初始化图片预览模态框
            previewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
            
            // 绑定图片预览按钮事件
            document.querySelectorAll('.preview-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const imageUrl = this.getAttribute('data-image-url');
                    openImagePreview(imageUrl);
                });
            });
            
            // 全屏按钮事件
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // 初始化模态框关闭事件
            document.getElementById('imagePreviewModal').addEventListener('hidden.bs.modal', () => {
                // 重置图片旋转角度
                currentRotation = 0;
                document.getElementById('previewImage').style.transform = '';
            });
            
            // 添加行点击效果
            document.querySelectorAll('.chemical-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (!e.target.closest('.btn') && !e.target.closest('input')) {
                        this.classList.toggle('highlight-result');
                    }
                });
            });
        });

        // 设置可调整列宽
        function setupResizableColumns() {
            const table = document.querySelector('.resizable-table');
            if (!table) return;
            
            const ths = table.querySelectorAll('thead th');
            ths.forEach(th => {
                // 跳过复选框列
                if (th.querySelector('input[type="checkbox"]')) return;
                
                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                th.appendChild(handle);
                
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    handle.classList.add('active');
                    
                    const startX = e.clientX;
                    const startWidth = th.offsetWidth;
                    
                    function doDrag(e) {
                        const newWidth = startWidth + e.clientX - startX;
                        th.style.width = `${newWidth}px`;
                        table.style.width = 'auto'; // 让表格自动调整宽度
                    }
                    
                    function stopDrag() {
                        document.removeEventListener('mousemove', doDrag);
                        document.removeEventListener('mouseup', stopDrag);
                        handle.classList.remove('active');
                    }
                    
                    document.addEventListener('mousemove', doDrag);
                    document.addEventListener('mouseup', stopDrag);
                });
            });
        }

        // 启用列宽调整
        function enableColumnResizing() {
            const handles = document.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.style.display = 'block';
            });
        }

        // 禁用列宽调整
        function disableColumnResizing() {
            const handles = document.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.style.display = 'none';
            });
        }

        // 重置列宽
        function resetColumnWidths() {
            const table = document.querySelector('.resizable-table');
            const ths = table.querySelectorAll('thead th');
            
            // 预设的列宽
            const defaultWidths = [
                '40px', '160px', '110px', '100px', '130px', '100px', 
                '90px', '90px', '90px', '100px', '100px', '100px', '100px', '100px', '450px'
            ];
            
            ths.forEach((th, index) => {
                if (index < defaultWidths.length) {
                    th.style.width = defaultWidths[index];
                }
            });
            
            table.style.width = '100%';
            showToast('列宽已重置为默认值', 'success');
        }

        // 更新批量操作面板状态
        function updateBatchPanel() {
            const checkedItems = document.querySelectorAll('.chemical-checkbox:checked');
            const batchPanel = document.getElementById('batchOperations');
            const actionResult = document.getElementById('actionResult');
            const cloneBtn = document.getElementById('cloneRecordBtn');
            
            if (checkedItems.length > 0) {
                batchPanel.classList.add('show');
                actionResult.textContent = `已选择 ${checkedItems.length} 项记录`;
                cloneBtn.disabled = false;
            } else {
                batchPanel.classList.remove('show');
                actionResult.textContent = '';
                cloneBtn.disabled = true;
            }
        }

        // 全选/取消全选
        function toggleSelectAll(checkbox) {
            const items = document.querySelectorAll('.chemical-checkbox');
            items.forEach(item => item.checked = checkbox.checked);
            updateBatchPanel();
            showToast(checkbox.checked ? '已全选所有记录' : '已取消全选', 'info');
        }

        // 执行批量操作
        async function executeBatchAction(actionType) {
            const checkedItems = document.querySelectorAll('.chemical-checkbox:checked');
            const actionResult = document.getElementById('actionResult');
            
            if (checkedItems.length === 0) {
                actionResult.innerHTML = "<span class='text-danger'>请先选择至少一条记录！</span>";
                return;
            }

            // 将NodeList转换为数组
            const chemicalIds = Array.from(checkedItems).map(item => parseInt(item.dataset.id));
            actionResult.innerHTML = `<span class="loading-spinner"></span> 正在查询${getActionName(actionType)}记录...`;

            try {
                const response = await fetch(`/secondary_search`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: actionType,
                        chemicalIds 
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`请求失败: ${response.status}`);
                }

                const result = await response.json();
                let resultHtml = '';

                if (result.records && result.records.length > 0) {
                    // 动态生成表头
                    const tableHeader = `
                        <thead class="table-light">
                            <tr>
                                ${actionType === 'last' ? '<th>最晚收支日期</th>' : ''}
                                <th>化学品名称</th>
                                <th>商品代码</th>
                                <th>操作类型</th>
                                <th>批次号</th>
                                <th>操作数量</th>
                                <th>此批总库存</th>
                                <th>总库存</th>
                                <th>收支日期</th>
                                <th>${actionType === 'last' ? '收支日期' : '操作时间'}</th>
                                <th>操作员</th>
                            </tr>
                        </thead>`;

                    // 动态生成表格内容
                    const tableBody = result.records.map(record => `
                        <tr>
                            ${actionType === 'last' ? `<td>${record.latest_date || '-'}</td>` : ''}
                            <td>${record.name}</td>
                            <td>${record.product_code}</td>
                            <td><span class="badge badge-status 
                                ${record.action === '入库' ? 'badge-in' : record.action === '出库' ? 'badge-out' : 'badge-check'}">
                                ${record.action}
                            </span></td>
                            <td>${record.batch_number || '-'}</td>
                            <td>${record.quantity || 0}</td>
                            <td>${record.batch_total_stock || 0}</td>
                            <td>${record.total_stock || 0}</td>
                            <td>${record.production_date || '-'}</td>
                            <td>${record.operation_date || '-'}</td>
                            <td>${record.operator || '-'}</td>
                        </tr>
                    `).join('');

                    resultHtml = `
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-table me-2"></i> ${getActionName(actionType)}查询结果</h5>
                                <span class="badge bg-primary">${result.records.length} 条记录</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        ${tableHeader}
                                        <tbody>${tableBody}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`;
                } else {
                    const checkedNames = Array.from(checkedItems).map(item => item.dataset.name).join(', ');
                    resultHtml = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i> 未找到相关记录
                            <div class="mt-2 small">查询条件: ${checkedNames}</div>
                        </div>`;
                }

                document.getElementById('resultContainer').innerHTML = resultHtml;
                actionResult.innerHTML = `<i class="bi bi-check-circle-fill text-success me-1"></i> 已查询 ${result.records?.length || 0} 条${getActionName(actionType)}记录`;

            } catch (error) {
                console.error('批量操作错误:', error);
                document.getElementById('resultContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i> 操作失败: ${error.message}
                    </div>`;
                actionResult.innerHTML = `<i class="bi bi-x-circle-fill text-danger me-1"></i> 查询失败`;
            }
        }

        // 获取操作名称
        function getActionName(actionType) {
            const actions = {
                'all': '全部',
                'in': '入库',
                'out': '出库',
                'check': '盘点',
                'last': '最后收货'
            };
            return actions[actionType] || '未知操作';
        }
        
        // 打开图片预览
        function openImagePreview(imageUrl) {
            const previewImage = document.getElementById('previewImage');
            const downloadLink = document.getElementById('downloadLink');
            
            // 设置图片源
            previewImage.src = imageUrl;
            previewImage.style.display = 'block';
            downloadLink.href = imageUrl;
            
            // 重置图片状态
            previewImage.style.transform = '';
            currentRotation = 0;
            
            // 显示模态框
            previewModal.show();
        }
        
        // 旋转图片
        function rotateImage(degrees) {
            currentRotation += degrees;
            const previewImage = document.getElementById('previewImage');
            previewImage.style.transform = `rotate(${currentRotation}deg)`;
        }
        
        // 改变预览大小
        function changePreviewSize(size) {
            const modalDialog = document.querySelector('#imagePreviewModal .modal-dialog');
            currentSize = size;
            
            switch(size) {
                case 'small':
                    modalDialog.classList.remove('modal-lg', 'modal-xl');
                    modalDialog.style.maxWidth = '500px';
                    break;
                case 'medium':
                    modalDialog.classList.remove('modal-xl');
                    modalDialog.classList.add('modal-lg');
                    modalDialog.style.maxWidth = '800px';
                    break;
                case 'large':
                    modalDialog.classList.remove('modal-lg');
                    modalDialog.classList.add('modal-xl');
                    modalDialog.style.maxWidth = '1140px';
                    break;
            }
        }
        
        // 切换全屏模式
        function toggleFullscreen() {
            const modal = document.getElementById('imagePreviewModal');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                if (modal.requestFullscreen) {
                    modal.requestFullscreen();
                } else if (modal.webkitRequestFullscreen) {
                    modal.webkitRequestFullscreen();
                } else if (modal.msRequestFullscreen) {
                    modal.msRequestFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
                fullscreenBtn.title = '退出全屏';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
                fullscreenBtn.title = '切换全屏';
            }
        }
        
        // 显示通知消息
        function showToast(message, type = 'info') {
            // 创建toast元素
            const toastContainer = document.createElement('div');
            toastContainer.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'info'} border-0`;
            toastContainer.setAttribute('role', 'alert');
            toastContainer.setAttribute('aria-live', 'assertive');
            toastContainer.setAttribute('aria-atomic', 'true');
            
            const toastBody = document.createElement('div');
            toastBody.className = 'd-flex align-items-center';
            
            const icon = document.createElement('i');
            icon.className = `bi ${type === 'success' ? 'bi-check-circle' : type === 'danger' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2`;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            
            toastBody.appendChild(icon);
            toastBody.appendChild(messageSpan);
            toastContainer.appendChild(toastBody);
            
            // 添加到页面
            document.body.appendChild(toastContainer);
            
            // 初始化并显示toast
            const toast = new bootstrap.Toast(toastContainer);
            toast.show();
            
            // 移除toast
            toastContainer.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastContainer);
            });
        }
        
        // 确认删除操作
        function confirmDelete(id) {
            if (confirm('确定要删除这条记录吗？此操作不可恢复。')) {
                fetch(`/delete/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        showToast('记录删除成功', 'success');
                        // 从DOM中移除该行
                        const row = document.querySelector(`.chemical-row[data-id="${id}"]`);
                        if (row) {
                            row.remove();
                        }
                    } else {
                        showToast('删除失败: ' + response.statusText, 'danger');
                    }
                })
                .catch(error => {
                    showToast('删除失败: ' + error.message, 'danger');
                });
            }
        }
        
        // 导出数据
        function exportData(format) {
            // 获取所有查询参数
            const params = new URLSearchParams(window.location.search);
            
            // 添加导出格式参数
            params.set('format', format);
            
            // 构建导出URL
            const exportUrl = `/export_search_results?${params.toString()}`;
            
            // 创建临时链接触发下载
            const link = document.createElement('a');
            link.href = exportUrl;
            link.target = '_blank';
            link.download = `化学品查询结果.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 克隆选中记录
        function cloneSelectedRecord() {
            const checkedItems = document.querySelectorAll('.chemical-checkbox:checked');
            
            if (checkedItems.length === 0) {
                showToast('请先选择一条记录进行复制', 'warning');
                return;
            }
            
            if (checkedItems.length > 1) {
                showToast('只能选择一条记录进行复制', 'warning');
                return;
            }
            
            const selectedId = checkedItems[0].getAttribute('data-id');
            const selectedName = checkedItems[0].getAttribute('data-name');
            
            // 跳转到克隆页面
            window.location.href = `/clone_chemical/${selectedId}`;
        }
    </script>
</body>
</html>